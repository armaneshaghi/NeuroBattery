<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="NeuroBattery : Smashing through the boundaries - of current neuroimage analysis limitations">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>NeuroBattery</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/jeffduda/NeuroBattery">View on GitHub</a>

          <h1 id="project_title">NeuroBattery</h1>
          <h2 id="project_tagline">Smashing through the boundaries - of current neuroimage analysis limitations</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/jeffduda/NeuroBattery/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/jeffduda/NeuroBattery/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="neurobattery" class="anchor" href="#neurobattery"><span class="octicon octicon-link"></span></a>NeuroBattery</h1>

<p>Here we provide a working example that illustrates the use of Advanced Normalization Tools (<a href="https://github.com/stnava/ANTs">ANTs</a>) to process multiple MR image types for a single subject. We provide and example input data for a single subject for which a battery of 5 different images were acquired in a single scanning session: </p>

<ol>
<li>T1 (MPRAGE)</li>
<li>pseudo continuous arterial spin labeling (PCASL)</li>
<li>diffusion weighted/tensor</li>
<li>resting state BOLD</li>
</ol><p>Additionally we provide a template and associated labels &amp; priors that we use as an anatomical basis for processing as well as a set of verified output image to ensure that your version is working correctly. The general concept is to use the anatomical information in the T1 images as a spatial frame-of-reference. Accordingly we find a spatial mapping between each subject's T1 image and the T1 template. Later, for additional MR images, we will perform intra subject alignment to the T1 allowing for mapping to template space by composing multiple transforms and retaining the concept of relying on the T1 images for anatomical reference for both intra and inter subject exploration of the data. After aligning the T1 image to the template we generate various images relating to anatomical properties of the brain. </p>

<h2>
<a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h2>

<ol>
<li><p>clone this repository and make sure you have R and its ggplot2 and rmarkdown libraries installed</p></li>
<li><p>install <a href="http://stnava.github.io/ANTs/">ANTs</a>,  <a href="http://stnava.github.io/ANTsR/">ANTsR</a> and <a href="https://github.com/cookpa/pipedream">pipedream</a> as described on their respective pages</p></li>
<li><p>cd into NeuroBattery/scripts/</p></li>
<li><p>type <code>./run_test.sh</code>  and then wait for the test to finish.</p></li>
<li><p>after processing has finished, the file `NeuroBattery/docs/PEDS012_20131101.pdf will be created. In this file, you will see a variety of measures generated from the results, these number will be compared to a set of reference results provided in NeuroBattery/data/reference/. Small differences ( &lt; 1% ) are to be expected. Larger differences may be a cause of concern.</p></li>
<li><p>if the test succeeds, then great.  now you can inspect both scripts and results and see how to do this yourself.</p></li>
</ol><p>Additional information below.</p>

<h2>
<a name="t1-mprage-image-processing" class="anchor" href="#t1-mprage-image-processing"><span class="octicon octicon-link"></span></a>T1 (MPRAGE) image processing</h2>

<p>A template image along with associated tissue-type priors serves as the reference for a registration-based approach to processing of the T1 subject data. Below are some example illustrations of the included template (<code>data/template/PTBP/PTBP_T1_Defaced.nii.gz</code>).</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_coronal.png?raw=true" alt="Full C"></p>

<p>An extraction mask of the template will help extract the brain from the input (<code>data/template/PTBP/PTBP_T1_ExtractionMask.nii.gz</code>). This is used to limit the area examined for an initial whole head registration between subject and template.</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_mask_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_mask_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_mask_coronal.png?raw=true" alt="Full C"></p>

<p>A brain mask of the template is transformed to subject space for brain extration (<code>data/template/PTBP/PTBP_T1_BrainCerebellumProbabilityMask.nii.gz</code>)</p>

<p>Tissue priors in the template will help segment the input data. Red=CSF, Green=Cortex, Blue=White matter, and Yellow=Deep gray matter, X=Brain stem, Y=Cerebellum (<code>data/template/PTBP/Priors/priors%d.nii.gz</code>)</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_prior_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_prior_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_prior_coronal.png?raw=true" alt="Full C"></p>

<p>These images, along with subject T1 data are used to generate a number of useful outputs, including:</p>

<ol>
<li>Bias corrected version of input image via N4</li>
<li>Brain extraction mask (cerebrum)</li>
<li>6-tissue segmentation (CSF,white matter, cortex, deep gray matter, brainstem, and cerebellum)</li>
<li>Cortical thickness</li>
<li>Spatial transform to template space (and inverse transform)</li>
</ol><p>In the script directory, <code>process_t1.sh</code> provides an example call to <code>antsCorticalThickness.sh</code> which is used to achieve the steps listed above. For this to work, the ANTSPATH environment variable must be set to point to ANTs executables and scripts. The full command is:</p>

<blockquote>
<p>sh  ${ANTSPATH}/antsCorticalThickness.sh -d 3 \
-a ../data/input/PEDS012/20131101/Anatomy/PEDS012_20131101_mprage_t1.nii.gz \
-e ../data/template/PTBP/PTBP_T1_Defaced.nii.gz \
-m ../data/template/PTBP/PTBP_T1_BrainCerebellumProbabilityMask.nii.gz \
-f ../data/template/PTBP/PTBP_T1_ExtractionMask \
-p ../data/template/PTBP/Priors/priors%d.nii.gz \
-t ../data/template/PTBP/PTBP_T1_BrainCerebellum.nii.gz \
-k 1 \
-n 3 \
-w 0.25 \
-o ../data/output/PEDS012/20131101/PEDS012_20131101_</p>
</blockquote>

<p>Here are some sample slices from the provided T1 input data (<code>data/input/PEDS012/20121031/Anatomy/PEDS012_20121031_mprage_t1.nii.gz</code>) followed by the results provided by <code>antsCorticalThickness.sh</code>.</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1_coronal.png?raw=true" alt="Full C"></p>

<p>The extracted cerebrum image:</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1brain_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1brain_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1brain_coronal.png?raw=true" alt="Full C"></p>

<p>The 4-class segmentation:</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1seg_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1seg_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1seg_coronal.png?raw=true" alt="Full C"></p>

<p>The cortical thickness, displayed as a heat-map overlay:</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1thick_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1thick_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1thick_coronal.png?raw=true" alt="Full C"></p>

<p>For quality control, we can visualize the mean cortical thickness within brain regions. The values for this subject are represented by the thick black line, while the red and blue lines represent the values for other subjects (blue=male) from the same dataset. </p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/thickness_spider.png?raw=true" alt="Full C"></p>

<p>Having processed the T1 image, we want to continue to use this data as our anatomical frame-of-reference. The processing of the additional data will all follow a similar pattern:</p>

<ol>
<li>Initial preprocessing to obtain a derived scalar image with relevant anatomical detail</li>
<li>Alignment of the derived scalar to the T1 data</li>
<li>Propagation of relevant labels, such as the brain mask, etc.</li>
<li>Quantification of modality specific metrics of interest.</li>
</ol><p>The output provided by antsCorticalThickness provides a brain extraction that extract cerebrum only. For inter-modality matching, we have found it useful to obtain a full-brain image, i.e. one that includes the cerebellum and brainstem. This image provides a reference for matching other modalities, such as diffusion weighted imaging, where there is signal throughout the brain, but little to no signal in the skull. A full-brain mask is included with the template (<code>data/template/T_templateFullBrainMask.nii.gz</code>). The same process used in <code>antsCorticalThickness.sh</code> is used to extract the brain, the only difference is that the cerebrum mask is replaced with the full brain mask.</p>

<p>Full-brain extraction</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1fullbrain_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1fullbrain_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1fullbrain_coronal.png?raw=true" alt="Full C"></p>

<h2>
<a name="diffusion-weighted-image-processing" class="anchor" href="#diffusion-weighted-image-processing"><span class="octicon octicon-link"></span></a>Diffusion weighted image processing</h2>

<p>The following steps are used to process diffusion tensor data. For the registration to T1, the T1 image is resample to 2mm isotropic voxels. Since the DWI is lower resolution than the T1, this provides a sufficient balance between accuracy, processing time, and disk space usage.</p>

<ol>
<li>Motion correction of the diffusion weighted volumes</li>
<li>Calculation of the diffusion tensor</li>
<li>Calculation of the mean diffusion weighted image (mDWI)</li>
<li>Registration and mDWI and the subjects full brain T1</li>
</ol><p>Here are slices from the subjects mDWI in it's original space</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwi_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwi_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwi_coronal.png?raw=true" alt="Full C"></p>

<p>The mDWI aligned to T1 and masked to cerebrum only</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwit1_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwit1_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwit1_coronal.png?raw=true" alt="Full C"></p>

<p>The subjects DT image is warped into T1 space and used to calculate a variety of metrics</p>

<p>Fractional Anisotropy</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_fa_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_fa_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_fa_coronal.png?raw=true" alt="Full C"></p>

<p>Primary direction of diffusion as overlay on T1</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dec_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dec_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dec_coronal.png?raw=true" alt="Full C"></p>

<p>Mean Diffusion</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_md_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_md_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_md_coronal.png?raw=true" alt="Full C"></p>

<p>Radial Diffusion</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_rd_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_rd_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_rd_coronal.png?raw=true" alt="Full C"></p>

<p>The AAL labels may then be transformed from the template into the subject DTI space for use as targets in fiber tractography, here illustrated as an overlay on the mDWI</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dtiaal_axial.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dtiaal_sagittal.png?raw=true" alt="Full C"><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dtiaal_coronal.png?raw=true" alt="Full C"></p>

<p>Whole brain tractography is used to obtain the following set of streamlines</p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/fibertracts.png?raw=true" alt="Full C"></p>

<p>These streamlines are used along with the AAL labels to generate a graph where edges represent the level of connectivity between two labeled regions. </p>

<p><img src="https://github.com/jeffduda/NeuroBattery/blob/master/figures/graph.png?raw=true" alt="Full C"></p>

<h2>
<a name="diffusion-tensor-reconstruction" class="anchor" href="#diffusion-tensor-reconstruction"><span class="octicon octicon-link"></span></a>Diffusion Tensor Reconstruction</h2>

<p>Diffusion tensor values are calculated from the DWI images using the nii2dt.sh script included with Pipedream. This script is essentially a wrapper that uses ANTs for motion correction and diffusion direction correction and Camino to perform the tensor estimation. This occurs in (<code>process_modalities.sh</code>) with the following command</p>

<blockquote>
<p>sh ${PIPEDREAMPATH}/nii2dt/nii2dt.sh \
--dwi ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.nii.gz \
      ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.nii.gz \
--bvals ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.bval \
        ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0019_DTI_1_1x0_30x1000.bval \
--bvecs ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.bvec \
        ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0019_DTI_1_1x0_30x1000.bvec \
--outroot PEDS012_20131101_DTI_ \
--outdir ../data/input/PEDS012/20131101/DTI</p>
</blockquote>

<h2>
<a name="pseudo-continuous-arterial-spin-labeling-pcasl-image-processing" class="anchor" href="#pseudo-continuous-arterial-spin-labeling-pcasl-image-processing"><span class="octicon octicon-link"></span></a>Pseudo continuous arterial spin labeling (PCASL) image processing</h2>

<h2>
<a name="resting-bold-fmri-processing" class="anchor" href="#resting-bold-fmri-processing"><span class="octicon octicon-link"></span></a>Resting BOLD fMRI processing</h2>

<h2>
<a name="dependencies" class="anchor" href="#dependencies"><span class="octicon octicon-link"></span></a>Dependencies</h2>

<p>ANTs - <a href="https://github.com/stnava/ANTs">https://github.com/stnava/ANTs</a> - 5f9d157cd8afb332c632c6fc35341420c93d031c
Pipedream - <a href="https://github.com/cookpa/pipedream">https://github.com/cookpa/pipedream</a> - 0125c2ab4dfecabfb7786c43056dc101c1e62af7
Camino - <a href="http://git.code.sf.net/p/camino/code">http://git.code.sf.net/p/camino/code</a> - 1b0935692fdc324d1325fcdb073e65fe057980ed
gdcm - <a href="http://git.code.sf.net/p/gdcm/gdcm">http://git.code.sf.net/p/gdcm/gdcm</a> -  7b2f37e5e51ed7cab1fc74438cb00800af85a3db
dcm2nii -  <a href="http://www.nitrc.org/frs/shownotes.php?release_id=2291">http://www.nitrc.org/frs/shownotes.php?release_id=2291</a> - 6/2013
java 1.7.0_13
cmake 2.8.12.1</p>

<p><strong>Whipping up a fury, Dominating flurry</strong></p>

<p><strong>We create the Battery</strong></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">NeuroBattery maintained by <a href="https://github.com/jeffduda">jeffduda</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
