{"name":"NeuroBattery","tagline":"Smashing through the boundaries - of current neuroimage analysis limitations","body":"NeuroBattery\r\n============\r\n\r\nHere we provide a working example that illustrates the use of Advanced Normalization Tools ([ANTs](https://github.com/stnava/ANTs)) to process multiple MR image types for a single subject. We provide and example input data for a single subject for which a battery of 5 different images were acquired in a single scanning session: \r\n\r\n1. T1 (MPRAGE)\r\n2. pseudo continuous arterial spin labeling (PCASL)\r\n3. diffusion weighted/tensor\r\n4. resting state BOLD\r\n\r\nAdditionally we provide a template and associated labels & priors that we use as an anatomical basis for processing as well as a set of verified output image to ensure that your version is working correctly. The general concept is to use the anatomical information in the T1 images as a spatial frame-of-reference. Accordingly we find a spatial mapping between each subject's T1 image and the T1 template. Later, for additional MR images, we will perform intra subject alignment to the T1 allowing for mapping to template space by composing multiple transforms and retaining the concept of relying on the T1 images for anatomical reference for both intra and inter subject exploration of the data. After aligning the T1 image to the template we generate various images relating to anatomical properties of the brain. \r\n\r\nGetting Started\r\n----------------\r\n\r\n0. clone this repository and make sure you have R and its ggplot2 and rmarkdown libraries installed\r\n\r\n1. install [ANTs](http://stnava.github.io/ANTs/),  [ANTsR](http://stnava.github.io/ANTsR/) and [pipedream](https://github.com/cookpa/pipedream) as described on their respective pages\r\n\r\n2. cd into Neurobattery/scripts/\r\n\r\n3. type  bash ./run_test.sh  and then wait for the test to finish.\r\n\r\n4. if the test succeeds, then great.  now you can inspect both scripts and results and see how to do this yourself.\r\n\r\nAdditional information below.\r\n\r\nT1 (MPRAGE) image processing\r\n------------------------\r\nA template image along with associated tissue-type priors serves as the reference for a registration-based approach to processing of the T1 subject data. Below are some example illustrations of the included template (`data/template/PTBP/PTBP_T1_Defaced.nii.gz`).\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_coronal.png?raw=true)\r\n\r\nAn extraction mask of the template will help extract the brain from the input (`data/template/PTBP/PTBP_T1_ExtractionMask.nii.gz`). This is used to limit the area examined for an initial whole head registration between subject and template.\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_mask_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_mask_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_mask_coronal.png?raw=true)\r\n\r\nA brain mask of the template is transformed to subject space for brain extration (`data/template/PTBP/PTBP_T1_BrainCerebellumProbabilityMask.nii.gz`)\r\n\r\nTissue priors in the template will help segment the input data. Red=CSF, Green=Cortex, Blue=White matter, and Yellow=Deep gray matter, X=Brain stem, Y=Cerebellum (`data/template/PTBP/Priors/priors%d.nii.gz`)\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_prior_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_prior_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/template_t1_prior_coronal.png?raw=true)\r\n\r\nThese images, along with subject T1 data are used to generate a number of useful outputs, including:\r\n\r\n1. Bias corrected version of input image via N4\r\n2. Brain extraction mask (cerebrum)\r\n3. 6-tissue segmentation (CSF,white matter, cortex, deep gray matter, brainstem, and cerebellum)\r\n4. Cortical thickness\r\n5. Spatial transform to template space (and inverse transform)\r\n\r\nIn the script directory, `process_t1.sh` provides an example call to `antsCorticalThickness.sh` which is used to achieve the steps listed above. For this to work, the ANTSPATH environment variable must be set to point to ANTs executables and scripts. The full command is:\r\n\r\n> sh  ${ANTSPATH}/antsCorticalThickness.sh -d 3 \\\r\n> -a ../data/input/PEDS012/20131101/Anatomy/PEDS012_20131101_mprage_t1.nii.gz \\\r\n> -e ../data/template/PTBP/PTBP_T1_Defaced.nii.gz \\\r\n> -m ../data/template/PTBP/PTBP_T1_BrainCerebellumProbabilityMask.nii.gz \\\r\n> -f ../data/template/PTBP/PTBP_T1_ExtractionMask \\\r\n> -p ../data/template/PTBP/Priors/priors%d.nii.gz \\\r\n> -t ../data/template/PTBP/PTBP_T1_BrainCerebellum.nii.gz \\\r\n> -k 1 \\\r\n> -n 3 \\\r\n> -w 0.25 \\\r\n> -o ../data/output/PEDS012/20131101/PEDS012_20131101_\r\n\r\nHere are some sample slices from the provided T1 input data (`data/input/PEDS012/20121031/Anatomy/PEDS012_20121031_mprage_t1.nii.gz`) followed by the results provided by `antsCorticalThickness.sh`.\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1_coronal.png?raw=true)\r\n\r\nThe extracted cerebrum image:\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1brain_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1brain_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1brain_coronal.png?raw=true)\r\n\r\nThe 4-class segmentation:\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1seg_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1seg_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1seg_coronal.png?raw=true)\r\n\r\nThe cortical thickness, displayed as a heat-map overlay:\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1thick_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1thick_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1thick_coronal.png?raw=true)\r\n\r\nFor quality control, we can visualize the mean cortical thickness within brain regions. The values for this subject are represented by the thick black line, while the red and blue lines represent the values for other subjects (blue=male) from the same dataset. \r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/thickness_spider.png?raw=true)\r\n\r\n\r\nHaving processed the T1 image, we want to continue to use this data as our anatomical frame-of-reference. The processing of the additional data will all follow a similar pattern:\r\n\r\n1. Initial preprocessing to obtain a derived scalar image with relevant anatomical detail\r\n2. Alignment of the derived scalar to the T1 data\r\n3. Propagation of relevant labels, such as the brain mask, etc.\r\n4. Quantification of modality specific metrics of interest.\r\n\r\nThe output provided by antsCorticalThickness provides a brain extraction that extract cerebrum only. For inter-modality matching, we have found it useful to obtain a full-brain image, i.e. one that includes the cerebellum and brainstem. This image provides a reference for matching other modalities, such as diffusion weighted imaging, where there is signal throughout the brain, but little to no signal in the skull. A full-brain mask is included with the template (`data/template/T_templateFullBrainMask.nii.gz`). The same process used in `antsCorticalThickness.sh` is used to extract the brain, the only difference is that the cerebrum mask is replaced with the full brain mask.\r\n\r\nFull-brain extraction\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1fullbrain_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1fullbrain_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_t1fullbrain_coronal.png?raw=true)\r\n\r\nDiffusion weighted image processing\r\n-------------------------------\r\n\r\nThe following steps are used to process diffusion tensor data. For the registration to T1, the T1 image is resample to 2mm isotropic voxels. Since the DWI is lower resolution than the T1, this provides a sufficient balance between accuracy, processing time, and disk space usage.\r\n\r\n1. Motion correction of the diffusion weighted volumes\r\n2. Calculation of the diffusion tensor\r\n3. Calculation of the mean diffusion weighted image (mDWI)\r\n4. Registration and mDWI and the subjects full brain T1\r\n\r\nHere are slices from the subjects mDWI in it's original space\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwi_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwi_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwi_coronal.png?raw=true)\r\n\r\nThe mDWI aligned to T1 and masked to cerebrum only\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwit1_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwit1_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dwit1_coronal.png?raw=true)\r\n\r\nThe subjects DT image is warped into T1 space and used to calculate a variety of metrics\r\n\r\nFractional Anisotropy\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_fa_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_fa_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_fa_coronal.png?raw=true)\r\n\r\nPrimary direction of diffusion as overlay on T1\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dec_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dec_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dec_coronal.png?raw=true)\r\n\r\nMean Diffusion\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_md_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_md_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_md_coronal.png?raw=true)\r\n\r\nRadial Diffusion\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_rd_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_rd_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_rd_coronal.png?raw=true)\r\n\r\nThe AAL labels may then be transformed from the template into the subject DTI space for use as targets in fiber tractography, here illustrated as an overlay on the mDWI\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dtiaal_axial.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dtiaal_sagittal.png?raw=true)\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/input_dtiaal_coronal.png?raw=true)\r\n\r\nWhole brain tractography is used to obtain the following set of streamlines\r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/fibertracts.png?raw=true)\r\n\r\nThese streamlines are used along with the AAL labels to generate a graph where edges represent the level of connectivity between two labeled regions. \r\n\r\n![Full C](https://github.com/jeffduda/NeuroBattery/blob/master/figures/graph.png?raw=true)\r\n\r\n\r\nDiffusion Tensor Reconstruction\r\n--------------------------------\r\nDiffusion tensor values are calculated from the DWI images using the nii2dt.sh script included with Pipedream. This script is essentially a wrapper that uses ANTs for motion correction and diffusion direction correction and Camino to perform the tensor estimation. This occurs in (`process_modalities.sh`) with the following command\r\n\r\n> sh ${PIPEDREAMPATH}/nii2dt/nii2dt.sh \\\r\n> --dwi ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.nii.gz \\\r\n>       ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.nii.gz \\\r\n> --bvals ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.bval \\\r\n>         ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0019_DTI_1_1x0_30x1000.bval \\\r\n> --bvecs ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0013_DTI_1_1x0_30x1000.bvec \\\r\n>         ../data/input/PEDS012/20131101/DWI/PEDS012_20131101_0019_DTI_1_1x0_30x1000.bvec \\\r\n> --outroot PEDS012_20131101_DTI_ \\\r\n> --outdir ../data/input/PEDS012/20131101/DTI\r\n\r\nPseudo continuous arterial spin labeling (PCASL) image processing\r\n----------------------------------\r\n\r\nResting BOLD fMRI processing\r\n----------------------------\r\n\r\n\r\nDependencies\r\n-------------\r\nANTs - https://github.com/stnava/ANTs - 5f9d157cd8afb332c632c6fc35341420c93d031c\r\nPipedream - https://github.com/cookpa/pipedream - 0125c2ab4dfecabfb7786c43056dc101c1e62af7\r\nCamino - http://git.code.sf.net/p/camino/code - 1b0935692fdc324d1325fcdb073e65fe057980ed\r\ngdcm - http://git.code.sf.net/p/gdcm/gdcm -  7b2f37e5e51ed7cab1fc74438cb00800af85a3db\r\ndcm2nii -  http://www.nitrc.org/frs/shownotes.php?release_id=2291 - 6/2013\r\njava 1.7.0_13\r\ncmake 2.8.12.1\r\n\r\n**Whipping up a fury, Dominating flurry**\r\n\r\n**We create the Battery**\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}